name: ROS2 Humble

on: [push]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-ros2-humble:
    runs-on: ubuntu-latest
    container:
      image: ros:humble
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
      - name: Install CasAdi Dependencies
        run: |
          bash -c 'apt update && \
          apt install -y gcc g++ gfortran git cmake liblapack-dev pkg-config --install-recommends && \
          apt install -y libopencl-clang-dev clang lldb lld llvm libclang-dev llvm-dev && \
          apt install -y --no-install-recommends coinor-libipopt-dev && \
          apt install -y ros-$ROS_DISTRO-osqp-vendor'
      - name: Cache CasAdi
        id: cache-casadi
        uses: actions/cache@v2
        with:
          path: |
            casadi
          key: ${{ runner.os }}-casadi
          restore-keys: |
            ${{ runner.os }}-casadi
      - name: Build Casadi
        if: steps.cache-casadi.outputs.cache-hit != 'true'
        run: |
          bash -c 'source /opt/ros/$ROS_DISTRO/setup.bash && \
          git clone https://github.com/casadi/casadi.git -b 3.6.4 casadi && \
          cd casadi && mkdir build && cd build && \
          cmake -DWITH_IPOPT=ON -DWITH_SLICOT=ON -DWITH_LAPACK=ON -DWITH_QPOASES=ON -DWITH_OSQP=ON -DWITH_CLANG=ON .. && \
          make && \
          make install && \
          echo export LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:/usr/local/lib" >> /etc/bash.bashrc'
      - name: Restore CasAdi
        if: steps.cache-casadi.outputs.cache-hit == 'true'
        run: |
          bash -c 'source /opt/ros/$ROS_DISTRO/setup.bash && \
          cd casadi/build && make install && \
          echo export LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:/usr/local/lib" >> /etc/bash.bashrc'
      - name: Install ROS Dependencies
        run: |
          bash -c 'source /opt/ros/$ROS_DISTRO/setup.bash && \
          apt-get update && rosdep update && \
          rosdep install --from-paths . --ignore-src -y'
      - name: Build Workspace
        run: |
          bash -c 'source /opt/ros/$ROS_DISTRO/setup.bash && \
          colcon build --cmake-args -DCMAKE_BUILD_TYPE=Release --packages-up-to racing_lmpc_launch --event-handlers console_cohesion+'
      # - name: Run Tests
      #   run: |
      #     bash -c 'source /opt/ros/$ROS_DISTRO/setup.bash; \
      #     # colcon test --event-handlers console_cohesion+; \
      #     # colcon test-result --verbose'